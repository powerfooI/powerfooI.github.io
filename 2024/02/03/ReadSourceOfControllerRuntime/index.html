<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Controller-runtime 源码阅读 - PowerfooI 的个人博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Somewhere - PowerfooI&#039;s Zone"><meta name="msapplication-TileImage" content="/img/apple-touch-icon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Somewhere - PowerfooI&#039;s Zone"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon.png"><meta name="description" content="Operator 是 Kubernetes 用来拓展其 API 的一种开发范式（Pattern），其核心是定义若干的自定义资源及其对应的资源控制器，当这些资源发生变化时其对应的控制器对变化进行调解（Reconcile），最终使得实际状态与预期状态达成一致。K8s-sigs 推出的 kubebuilder 是一个用于构建 Operator 应用的框架，和 Operator-SDK 一样都依赖了 co"><meta property="og:type" content="blog"><meta property="og:title" content="Controller-runtime 源码阅读"><meta property="og:url" content="https://powerfooi.github.io/2024/02/03/ReadSourceOfControllerRuntime/"><meta property="og:site_name" content="PowerfooI 的个人博客"><meta property="og:description" content="Operator 是 Kubernetes 用来拓展其 API 的一种开发范式（Pattern），其核心是定义若干的自定义资源及其对应的资源控制器，当这些资源发生变化时其对应的控制器对变化进行调解（Reconcile），最终使得实际状态与预期状态达成一致。K8s-sigs 推出的 kubebuilder 是一个用于构建 Operator 应用的框架，和 Operator-SDK 一样都依赖了 co"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://powerfooi.github.io/gallery/covers/Controller-runtime.png"><meta property="article:published_time" content="2024-02-03T13:56:52.000Z"><meta property="article:modified_time" content="2024-08-04T02:40:36.185Z"><meta property="article:author" content="PowerfooI"><meta property="article:tag" content="Reading"><meta property="article:tag" content="CloudNative"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://powerfooi.github.io/gallery/covers/Controller-runtime.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://powerfooi.github.io/2024/02/03/ReadSourceOfControllerRuntime/"},"headline":"Controller-runtime 源码阅读","image":["https://powerfooi.github.io/gallery/covers/Controller-runtime.png"],"datePublished":"2024-02-03T13:56:52.000Z","dateModified":"2024-08-04T02:40:36.185Z","author":{"@type":"Person","name":"PowerfooI"},"publisher":{"@type":"Organization","name":"PowerfooI 的个人博客","logo":{"@type":"ImageObject","url":{"text":"Somewhere - PowerfooI's Zone"}}},"description":"Operator 是 Kubernetes 用来拓展其 API 的一种开发范式（Pattern），其核心是定义若干的自定义资源及其对应的资源控制器，当这些资源发生变化时其对应的控制器对变化进行调解（Reconcile），最终使得实际状态与预期状态达成一致。K8s-sigs 推出的 kubebuilder 是一个用于构建 Operator 应用的框架，和 Operator-SDK 一样都依赖了 co"}</script><link rel="canonical" href="https://powerfooi.github.io/2024/02/03/ReadSourceOfControllerRuntime/"><link rel="alternate" href="/atom.xml" title="PowerfooI 的个人博客" type="application/atom+xml"><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?371b1d983749aad213c30979122b6579";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-TNMDKQMTYG" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-TNMDKQMTYG');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Somewhere - PowerfooI&#039;s Zone</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/PowerfooI"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/gallery/covers/Controller-runtime.png" alt="Controller-runtime 源码阅读"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-02-03T13:56:52.000Z" title="2/3/2024, 9:56:52 PM">2024-02-03</time>发表</span><span class="level-item"><a class="link-muted" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></span><span class="level-item">29 分钟读完 (大约4317个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Controller-runtime 源码阅读</h1><div class="content"><p>Operator 是 Kubernetes 用来拓展其 API 的一种开发范式（Pattern），其核心是定义若干的自定义资源及其对应的资源控制器，当这些资源发生变化时其对应的控制器对变化进行调解（Reconcile），最终使得实际状态与预期状态达成一致。K8s-sigs 推出的 <a href="https://book.kubebuilder.io/">kubebuilder</a> 是一个用于构建 Operator 应用的框架，和 <a href="https://github.com/operator-framework/operator-sdk">Operator-SDK</a> 一样都依赖了 <a href="https://github.com/kubernetes-sigs/controller-runtime">controller-runtime</a>，提供了高级 API 和抽象，让开发者更直观地编写操作逻辑，并提供用于快速启动新项目的脚手架和代码生成工具。</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>截至目前我已经参与了两个 Operator 项目的搭建和维护，均采用了 kubebuilder 做基础脚手架。我目前对 CRD 的设计生成、Webhook 的校验机制和、Controller 的控制循环机制有了一定认识，接触时间稍长后在日常开发 Operator 项目时难免出现缺乏新意的情况，Operator 模式看久了和 CURD 之于后端有些许相似。但我乐观地估计通过观察下层实现可以收获一些启发。既然 kubebuilder 和 Operator-SDK 都依赖了 controller-runtime，那么就先从它出发吧。</p>
<span id="more"></span>

<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><h2 id="MindMap"><a href="#MindMap" class="headerlink" title="MindMap"></a>MindMap</h2><p>controller-runtime 这个包的内容不少，为了在一篇文章里能覆盖到，本文仅选取在构建 Operator 过程中起关键作用的包进行介绍，<code>envtest</code>、<code>scheme</code>、<code>certwatcher</code> 等同样重要的包就不在此提及。下面是我读代码时画的意识流思维导图，有的子项目是组成结构，有的子项目是工作角色，比较自由灵活。我选取了 <code>Cache</code>,<code>Source</code>, <code>Handler</code>, <code>Client</code>, <code>Controller</code> 和 <code>Manager</code> 这六个包。</p>
<img src="/2024/02/03/ReadSourceOfControllerRuntime/Controller-runtime.png" class="" title="意识流的思维导图">

<h2 id="WorkFlow"><a href="#WorkFlow" class="headerlink" title="WorkFlow"></a>WorkFlow</h2><p>对于控制器而言，资源发生变动的信息均来自于 API Server，从资源发生变动到控制器完成调解需要经过多个模块的处理，大体来说可以用下面的图来表示。</p>
<img src="/2024/02/03/ReadSourceOfControllerRuntime/Controller-workflow.png" class="" title="控制器工作流程">

<h1 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h1><p>Cache 包通过 Informers 接口封装了 client-go 中的缓存机制 SharedInformer，为每个资源类型都创建对应的 Informer，通过它们的缓存避免所有请求都直接访问 API Server 导致其可能的不堪重负。SharedInformer 机制在 client-go 中定义，它采用增量同步的方式从 API Server 处“订阅”某类资源的事件，并且将事件的增量更新保存在本地存储（Store）当中，其中典型的存储是 DeltaFIFO。SharedInformer 是 k8s client-go 中的核心机制，几乎所有的客户端应用都绕不开它，之后有空再阅读查看其中细节，这里我们不再展开。</p>
<p>控制流路径大致为 cache.New -&gt; newCache -&gt; internal.NewInformers -&gt; sharedInformers，其中：</p>
<ul>
<li>cluster 初始化时通过 <code>cache.New</code> 创建集群资源缓存，默认的创建缓存方法可以通过传入自定义的缓存初始化函数进行 Mock，大多数情况下不需要传入自定义的函数；</li>
<li>在 Cache 的初始化函数当中可以为每个类型的资源定义细粒度的缓存策略，通过 <code>cache.Options</code> 中的 <code>ByObject</code> 字段进行配置。在 <code>manager.Options</code> 中的 <code>Cache</code> 就是负责控制缓存的行为的字段。</li>
<li><code>internal.Informers</code> 提供了 <code>Get</code>、<code>Peek</code> 和 <code>Remove</code> 方法。其中 Get 方法中调用 Peek，若没有获取到指定的 sharedInformer，会根据配置参数中的 <code>newInformer</code> 方法创建出来并且添加到 map 当中留作后用；Peek 方法若无法从 map 中获取到也不会自动启动新的 sharedInformer。</li>
<li>通过 <code>internal.Informers</code> 获取到 sharedInformer，后续的 Source 包能够将事件处理器与其绑定，将从 API Server 处同步到的对象变更事件转化为控制器循环当中的 <code>reconcile.Request</code> 对象。</li>
</ul>
<h1 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h1><p><code>Source</code> 顾名思义是来源，但准确来讲这个来源是请求的来源，也就是在 kubebuilder 中所有的控制器需要实现的 Reconcile 方法的 requests.Request 这一参数的生产者。在 Source 有三种类型，Channel，Informer 和 Func。</p>
<p>其中 <a href="https://github.com/kubernetes-sigs/controller-runtime/blob/7032a3cc91d2afc4c2d54e4a4891cf75da9f75f5/pkg/source/source.go#L67-L86">Channel</a> 类型主要用于外部事件的处理，例如 Github 的 Webhook，需要用户自行编写外部的 Source 来将通用事件写入到内部的 Channel 当中。</p>
<p>Informer 类型的 Source 在控制器当中最常用，它封装了 client-go 的 cache.Informer 接口，将事件处理器与 informer 进行绑定，用于产生源于集群内部的事件，例如 Pod 的创建等。</p>
<figure class="highlight go"><figcaption><span>pkg/source.go:184-206</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Informer is used to provide a source of events originating inside the cluster from Watches (e.g. Pod Create).</span></span><br><span class="line"><span class="keyword">type</span> Informer <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Informer is the controller-runtime Informer</span></span><br><span class="line">	Informer cache.Informer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ Source = &amp;Informer&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start is internal and should be called only by the Controller to register an EventHandler with the Informer</span></span><br><span class="line"><span class="comment">// to enqueue reconcile.Requests.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(is *Informer)</span></span> Start(ctx context.Context, handler handler.EventHandler, queue workqueue.RateLimitingInterface,</span><br><span class="line">	prct ...predicate.Predicate) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// Informer should have been specified by the user.</span></span><br><span class="line">	<span class="keyword">if</span> is.Informer == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;must specify Informer.Informer&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err := is.Informer.AddEventHandler(internal.NewEventHandler(ctx, queue, handler, prct).HandlerFuncs())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 Source 接口只有一个 Start() 方法，所以 Func 类型只是为了方便将单个函数实现成为这个接口而封装出来的类型，在此不再作更多介绍。</p>
<p>在 Source 的内部实现 (<code>pkg/internal/source</code>) 中，它将从 Informer 中获取到的对象转换为 Create，Update，Delete 和 Generic 四类事件，四类事件分别由相应的事件处理器进行下一步的处理。其中，事件处理器在 Handler 包中定义，Informer 在 Cache 包中定义。</p>
<h1 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h1><figure class="highlight go"><figcaption><span>pkg/handler.go:44-57</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> EventHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Create is called in response to a create event - e.g. Pod Creation.</span></span><br><span class="line">	Create(context.Context, event.CreateEvent, workqueue.RateLimitingInterface)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called in response to an update event -  e.g. Pod Updated.</span></span><br><span class="line">	Update(context.Context, event.UpdateEvent, workqueue.RateLimitingInterface)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete is called in response to a delete event - e.g. Pod Deleted.</span></span><br><span class="line">	Delete(context.Context, event.DeleteEvent, workqueue.RateLimitingInterface)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Generic is called in response to an event of an unknown type or a synthetic event triggered as a cron or</span></span><br><span class="line">	<span class="comment">// external trigger request - e.g. reconcile Autoscaling, or a Webhook.</span></span><br><span class="line">	Generic(context.Context, event.GenericEvent, workqueue.RateLimitingInterface)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Source 将事件处理器 EventHandlers 和 Informers 进行绑定，Handlers 将某个某类型资源 A 的事件 Event 转化为某类型资源 B 的事件请求 Request 推入工作队列（<code>workqueue.RateLimitingInterface</code>，定义在 client-go 当中），其中 A 通常等于 B，但也存在 A 不等于 B 的情况。下面将两种情况区分介绍。</p>
<p><strong>1. A &#x3D;&#x3D; B</strong></p>
<p>A &#x3D;&#x3D; B 也就是说产生事件的资源和需要调解的资源类型是相同的，例如用户提交了一个 Pod，那 Pod 的控制器就会接收到这个 Pod 被创建的事件，并对该事件进行调解。这是最普遍的情况，在 <code>pkg/handler/enqueue.go</code> 中有该情况的实现。</p>
<p><strong>2. A !&#x3D; B</strong></p>
<p>A !&#x3D; B 说明在类型 A 产生的事件要发送给类型 B 的控制器进行调解，这在单一资源&#x2F;控制器的语境下没有太大的意义，但如果将资源的从属关系也纳入其中就很好解释了：父级资源在子资源发生变更时收到相应的事件，级联地调解自身的状态，进而加速多级资源结构整体的调解速度。例如 ReplicaSet 资源应该监听其拥有的 Pod 资源的事件，当 Pod 状态发生变化时，ReplicaSet 控制器也应该调解 ReplicaSet 资源的状态或配置，以求符合预期。</p>
<p>在 <code>pkg/handler/enqueue_owner.go</code> 和 <code>enqueue_mapped.go</code> 中有 A !&#x3D; B 时的 handler 方法实现。其中 <code>enqueue_owner.go</code> 中为我们实现了“子资源变更，父资源调解”的逻辑，在 kubebuilder 中在 builder 方法下使用 <code>Owns()</code> 方法可以声明从属关系，从而让我们的控制器能够调解拥有的其他资源的“此类资源”。</p>
<p>而 <code>enqueue_mapped.go</code> 则封装了更为通用的事件处理器方法，能够让用户自定义从 client.Object 到 reconcile.Request 的映射，实现更为灵活的事件入队逻辑。</p>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><p>Controller 控制器是我们要补充编码并最终运行的若干实体，它们负责从 K8s 的控制循环中取回对应资源的事件，并且调用自身的调解函数（也就是我们在编写 Operator 时补充的 Reconcile 函数）完成资源状态对齐的任务。如开头的思维导图所示，我列出了 <code>Reconcile</code>，<code>Workqueue</code>，<code>Watches()</code> 和 <code>Metadata Projection</code> 这些子项目，下面分别就这些内容进行介绍。</p>
<figure class="highlight go"><figcaption><span>pkg/internal/controller/controller.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Name is used to uniquely identify a Controller in tracing, logging and monitoring.  Name is required.</span></span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// MaxConcurrentReconciles is the maximum number of concurrent Reconciles which can be run. Defaults to 1.</span></span><br><span class="line">	MaxConcurrentReconciles <span class="type">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Reconciler is a function that can be called at any time with the Name / Namespace of an object and</span></span><br><span class="line">	<span class="comment">// ensures that the state of the system matches the state specified in the object.</span></span><br><span class="line">	<span class="comment">// Defaults to the DefaultReconcileFunc.</span></span><br><span class="line">	Do reconcile.Reconciler</span><br><span class="line"></span><br><span class="line">	<span class="comment">// MakeQueue constructs the queue for this controller once the controller is ready to start.</span></span><br><span class="line">	<span class="comment">// This exists because the standard Kubernetes workqueues start themselves immediately, which</span></span><br><span class="line">	<span class="comment">// leads to goroutine leaks if something calls controller.New repeatedly.</span></span><br><span class="line">	MakeQueue <span class="function"><span class="keyword">func</span><span class="params">()</span></span> workqueue.RateLimitingInterface</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queue is an listeningQueue that listens for events from Informers and adds object keys to</span></span><br><span class="line">	<span class="comment">// the Queue for processing</span></span><br><span class="line">	Queue workqueue.RateLimitingInterface</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reconcile"><a href="#Reconcile" class="headerlink" title="Reconcile"></a>Reconcile</h2><p>Reconcile 函数也就是<a href="https://github.com/kubernetes-sigs/controller-runtime/blob/7032a3cc91d2afc4c2d54e4a4891cf75da9f75f5/pkg/internal/controller/controller.go#L41">控制器结构体（pkg&#x2F;internal&#x2F;controller）</a>当中 <code>Do</code> 这个字段的具体实现，它接收 <code>reconcile.Request</code> 返回 <code>reconcile.Result</code>，这两个参数类型都极为简单，从中可以表现出 controller-runtime 的设计者们希望把最简单的接口留给开发者。reconcile.Request 其实就是 <code>NamespacedName</code>，reconcile.Result 则包含了两个字段 <code>Requeue</code> 和 <code>RequeueAfter</code>，分别表示是否重新入队和多久后重新入队。这与后续的工作队列模块相互配合，支持我们实现有计划、有规律的调解重试。</p>
<h2 id="Workqueue"><a href="#Workqueue" class="headerlink" title="Workqueue"></a>Workqueue</h2><p>Workqueue 顾名思义是工作队列，与 Controller 控制器和 Source 事件源相互配合，完成对资源变更事件的有序处理过程。workqueue 是 client-go 中的 <code>workqueue.RateLimitingInterface</code> 接口，也就是速率受限的工作队列，限定速率的工作由 <code>rateLimiter</code> 接口完成，一个对象需要先经过 rateLimiter 同意才能够顺利入队，速率限定器的逻辑可由用户自行定义，但大部分 K8s 客户端的场景当中，使用默认的速率限定逻辑即可。速率受限的工作队列也在 client-go 中完成定义，之后的文章中有机会再探讨。</p>
<h2 id="Watches"><a href="#Watches" class="headerlink" title="Watches"></a>Watches</h2><p>Watches 方法将某一类对象包装成为 Source，并将其通过事件处理器 Handler 与工作队列进行关联。在 Kubebuilder 当中我们直接使用的方法是 <code>ControllerManagedBy</code>，它采用构建者模式返回一个 <code>Builder</code> 类型的结构，支持我们链式调用配置方法，最终通过 <code>Complete</code> 方法完成控制器的构建。在 Builder 结构体下暴露了若干的方法，其中有 For，Owns 和 Watches 这三个方法用于绑定 Source 和 Handler。For 和 Owns 其实是 Watches 的语法糖，它们分别表示监听某类资源和监听拥有的某类资源（从属关系通过 OwnerReferences 构建），都可以通过 Watches 方法来实现。</p>
<p>Watches 方法接受 <code>client.Object</code>，<code>handler.EventHandler</code> 和 <code>WatchesOption</code> 作为参数，从集群的缓存中拿到某类资源的 Informer 封装为 Source，绑定上事件处理器。handler 包中提供的两个现有的方法分别构成了 For 和 Owns 两个方法对 Watches 封装的语法糖。</p>
<p>Watches 的行为还会收到 Predicates 的影响，Predicates 起过滤作用，用来决定什么事件应该进入工作队列，什么事件不应该进入工作队列。刚开始接触 Controller runtime 时许多开发者经常会遇到资源 Spec 变更后触发调解，控制器更新资源 Status 之后再次触发调解的莫名其妙的死循环，这个情况就是 Predicate 没有正确设置，当资源（包括 Status）发生更新后，资源的 ResourceVersion 会发生变更，但如果不希望 Status 更新后触发调解，可以在 <code>builder.WithEventFilter()</code> 中传入预先定义好的 <code>predicate.GenerationChangedPredicate&#123;&#125;</code>，这样会过滤掉 ResourceVersion 发生变更的事件。</p>
<h2 id="Metadata-Projection"><a href="#Metadata-Projection" class="headerlink" title="Metadata Projection"></a>Metadata Projection</h2><p>在 Controller Builder 包中有个类型是 <code>objectProjection</code> 表示对象的投影。在调用 For，Owns 和 Watches 三个方法时可以通过末尾的不定长选项参数传入有关投影的配置，builder.OnlyMetadata 就是这样的配置。OnlyMetadata 用来告诉控制器只需要缓存元信息，并且只通过 MetadataClient Watch 元信息格式的资源对象。这对于某类资源对象众多、资源占据空间极大或者只知道资源的 GVK 不知道资源的具体结构等情况是非常有用的。</p>
<h1 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h1><p>Controller Manager 控制器管理器管理了包括控制器在内的若干可运行接口（Runnable），只要实现了方法 <code>Start(context.Context) error</code> 就能够成为 Runnable，上述介绍的若干模块都实现了这个方法，例如 Cache, Source, Controller，还有未提及的 Webhook，HttpServer，LeaderElection 等。管理器自身也实现了 Start 方法，用于在我们的主程序中调用运行。上述所有模块的配置也都可以通过 Manager 的配置进行传入，换句话说，Manager 的配置整合了所有其他模块的配置信息。</p>
<p>Manager 还封装了 Cluster 这个接口，cluster 包含了 <code>rest.Config</code>, <code>runtime.Scheme</code>, <code>Cache</code>, <code>client.Reader</code> 和 <code>meta.RESTMapper</code> 等包含集群信息的重要字段，Cluster 接口所有的方法都是只读的，也确定了该结构就是单纯用于“信息查阅”的。</p>
<h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><p>Client 封装了常用的客户端功能，Get 和 List 操作优先从缓存中读取，Create，Update 和 Delete 等写入操作直接与 API Server 进行通信。当然可以在初始化客户端时通过 <code>client.Options.Cache.DisableFor</code> 字段配置禁用某些资源类型的缓存，直接从 API Server 读取。</p>
<h1 id="启发"><a href="#启发" class="headerlink" title="启发"></a>启发</h1><h2 id="对外的-API-保持简单"><a href="#对外的-API-保持简单" class="headerlink" title="对外的 API 保持简单"></a>对外的 API 保持简单</h2><p>如果不读源码，不仔细读文档，我们能够接触到的接口无非就是 Controller Builder 的使用和 Reconcile 方法，了解 K8s 的控制循环逻辑就可以开始编写 Operator 的代码。Controller-runtime 高内聚的特点将简单留给了开发者，复杂性由设计者和维护者承担。</p>
<p>同时也可以看到为了保持依赖的简洁，Controller-runtime 从其他地方(k8s.io&#x2F;kubernetes)复制了一些文件到本地，从而<a href="https://github.com/kubernetes-sigs/controller-runtime/blob/7032a3cc91d2afc4c2d54e4a4891cf75da9f75f5/pkg/internal/flock/doc.go#L17-L21">避免了直接依赖整个包</a>。虽然不优雅，但不得不说实用主义在这里再次赢得了胜利。</p>
<h2 id="多利用编译阶段的静态检查"><a href="#多利用编译阶段的静态检查" class="headerlink" title="多利用编译阶段的静态检查"></a>多利用编译阶段的静态检查</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Source <span class="keyword">interface</span> &#123;</span><br><span class="line">  <span class="comment">// Some methods</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> kind <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// Some fields</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ Source = kind&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码段定义了一个公开接口和一个内部结构，通过 <code>var _ Source = kind&#123;&#125;</code> 这个语句在编译阶段保障我们的结构实现了指定的接口，而因为变量名为空，在编译完成后该变量会被抛弃，对程序的运行状态没有影响。这个小技巧可以在之后的开发中多加使用，尽早避免可能出现的<code>未完全实现某接口</code>导致的运行时错误。</p>
<h2 id="Option-接口"><a href="#Option-接口" class="headerlink" title="Option 接口"></a>Option 接口</h2><p>在 Controller runtime 中广泛出现 Option 接口的实现，各种配置都通过传递 Option 接口来完成，下面是其中一处源码片段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ForOption <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// ApplyToFor applies this configuration to the given for input.</span></span><br><span class="line">	ApplyToFor(*ForInput)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Predicates <span class="keyword">struct</span> &#123;</span><br><span class="line">	predicates []predicate.Predicate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ApplyToFor applies this configuration to the given ForInput options.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w Predicates)</span></span> ApplyToFor(opts *ForInput) &#123;</span><br><span class="line">	opts.predicates = w.predicates</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(blder *Builder)</span></span> For(object client.Object, opts ...ForOption) *Builder &#123;</span><br><span class="line">	<span class="keyword">if</span> blder.forInput.object != <span class="literal">nil</span> &#123;</span><br><span class="line">		blder.forInput.err = fmt.Errorf(<span class="string">&quot;For(...) should only be called once, could not assign multiple objects for reconciliation&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> blder</span><br><span class="line">	&#125;</span><br><span class="line">	input := ForInput&#123;object: object&#125;</span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		opt.ApplyToFor(&amp;input)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	blder.forInput = input</span><br><span class="line">	<span class="keyword">return</span> blder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们为多个类型实现了 Option 接口的方法，这样多个类型可以作为相同的类型传递给同一个函数，例如 For 当中的 Predicate 和 ObjectProjection 等。通过 Option 接口可以获得更高的配置灵活性。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Controller-runtime 源码阅读</p><p><a href="https://powerfooi.github.io/2024/02/03/ReadSourceOfControllerRuntime/">https://powerfooi.github.io/2024/02/03/ReadSourceOfControllerRuntime/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>PowerfooI</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-02-03</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-08-04</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Reading/">Reading</a><a class="link-muted mr-2" rel="tag" href="/tags/CloudNative/">CloudNative</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=660fc46b8643100019977f2b&amp;product=inline-share-buttons&amp;source=platform" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/02/27/YetAnotherImporter-VSCode/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">VSCode 插件 - YAI</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/01/13/WhatHappensWhenK8s/"><span class="level-item">当我执行 kubectl create 时发生了什么[译]</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "ab90cd363d53069647ecadf6baac7068",
            repo: "powerfooI.github.io",
            owner: "powerfooI",
            clientID: "de634a427346094182ce",
            clientSecret: "977edb8eca9693667f47bdbb9ab33c9739f1c494",
            admin: ["powerfooI"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/logo.png" alt="PowerfooI"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">PowerfooI</p><p class="is-size-6 is-block">码农，努力成为软件工程师</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>浙江杭州</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">36</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">37</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/PowerfooI" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Summary"><span class="level-left"><span class="level-item">1</span><span class="level-item">Summary</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#MindMap"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">MindMap</span></span></a></li><li><a class="level is-mobile" href="#WorkFlow"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">WorkFlow</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Cache"><span class="level-left"><span class="level-item">2</span><span class="level-item">Cache</span></span></a></li><li><a class="level is-mobile" href="#Source"><span class="level-left"><span class="level-item">3</span><span class="level-item">Source</span></span></a></li><li><a class="level is-mobile" href="#Handler"><span class="level-left"><span class="level-item">4</span><span class="level-item">Handler</span></span></a></li><li><a class="level is-mobile" href="#Controller"><span class="level-left"><span class="level-item">5</span><span class="level-item">Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Reconcile"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">Reconcile</span></span></a></li><li><a class="level is-mobile" href="#Workqueue"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">Workqueue</span></span></a></li><li><a class="level is-mobile" href="#Watches"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">Watches</span></span></a></li><li><a class="level is-mobile" href="#Metadata-Projection"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">Metadata Projection</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Controller-Manager"><span class="level-left"><span class="level-item">6</span><span class="level-item">Controller Manager</span></span></a></li><li><a class="level is-mobile" href="#Client"><span class="level-left"><span class="level-item">7</span><span class="level-item">Client</span></span></a></li><li><a class="level is-mobile" href="#启发"><span class="level-left"><span class="level-item">8</span><span class="level-item">启发</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#对外的-API-保持简单"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">对外的 API 保持简单</span></span></a></li><li><a class="level is-mobile" href="#多利用编译阶段的静态检查"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">多利用编译阶段的静态检查</span></span></a></li><li><a class="level is-mobile" href="#Option-接口"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">Option 接口</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">学习</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-01T12:22:17.000Z">2025-03-01</time></p><p class="title"><a href="/2025/03/01/BackToBeijing/">回旋镖之重回北京</a></p><p class="categories"><a href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-02-15T14:38:41.000Z">2025-02-15</time></p><p class="title"><a href="/2025/02/15/LearnReactAgain/">再次认识 React</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-31T00:46:33.000Z">2024-12-31</time></p><p class="title"><a href="/2024/12/31/ForMy2024/">2024 年终总结</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-25T14:20:38.000Z">2024-12-25</time></p><p class="title"><a href="/2024/12/25/UseMacLikeWindows/">像使用 Windows 一样使用 MacOS</a></p><p class="categories"><a href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-04T15:20:06.000Z">2024-12-04</time></p><p class="title"><a href="/2024/12/04/WriteCodeWithCursor/">用 Cursor 快速搭建软件原型</a></p><p class="categories"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AI/"><span class="tag">AI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AccessControl/"><span class="tag">AccessControl</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CI-CD/"><span class="tag">CI/CD</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CloudNative/"><span class="tag">CloudNative</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Coding/"><span class="tag">Coding</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Deployment/"><span class="tag">Deployment</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docs/"><span class="tag">Docs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECMAScript/"><span class="tag">ECMAScript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GC/"><span class="tag">GC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Github/"><span class="tag">Github</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GraphQL/"><span class="tag">GraphQL</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lint/"><span class="tag">Lint</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MacOS/"><span class="tag">MacOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NPM/"><span class="tag">NPM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Network/"><span class="tag">Network</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RAG/"><span class="tag">RAG</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/React/"><span class="tag">React</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reading/"><span class="tag">Reading</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tools/"><span class="tag">Tools</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TypeScript/"><span class="tag">TypeScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VSCode/"><span class="tag">VSCode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vue/"><span class="tag">Vue</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Web-Server/"><span class="tag">Web Server</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows/"><span class="tag">Windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%91%E6%B8%B8%E6%88%8F/"><span class="tag">云游戏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%BB%E7%BB%93/"><span class="tag">总结</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%84%E5%BD%B1/"><span class="tag">摄影</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B8%E6%88%8F/"><span class="tag">游戏</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B8%E8%AE%B0/"><span class="tag">游记</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%83%A1%E6%80%9D%E4%B9%B1%E6%83%B3/"><span class="tag">胡思乱想</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%BB%E5%90%8E%E6%84%9F/"><span class="tag">读后感</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Somewhere - PowerfooI&#039;s Zone</a><p class="is-size-7"><span>&copy; 2025 PowerfooI</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Visit GitHub Profile" href="https://github.com/powerfooi/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>